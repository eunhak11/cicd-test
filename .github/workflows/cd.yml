# CD ì›Œí¬í”Œë¡œìš°: AWS S3 ìë™ ë°°í¬
name: CD - Deploy to AWS S3

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´: main ë¸Œëœì¹˜ì— í‘¸ì‹œë˜ê³  CIê°€ ì„±ê³µí–ˆì„ ë•Œ
on:
  workflow_run:
    workflows: ["CI - Code Quality Linter"] 
    types:
      - completed
    branches: [main]

# AWS ë°°í¬ë¥¼ ìœ„í•œ ê¸°ë³¸ ê¶Œí•œ
permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to AWS S3
    runs-on: ubuntu-latest

    # CI ì›Œí¬í”Œë¡œìš°ê°€ ì„±ê³µí–ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2  # ì„œìš¸ ë¦¬ì „

      - name: Deploy to S3
        run: |
          # S3ì— íŒŒì¼ ë™ê¸°í™” (HTML, CSSë§Œ ì—…ë¡œë“œ)
          aws s3 sync . s3://cicd-test-eunhak  \
            --exclude "*" \
            --include "*.html" \
            --include "*.css" \
            --delete \
            --cache-control "max-age=86400"

          # S3 ë²„í‚· ì •ì  ì›¹ì‚¬ì´íŠ¸ í˜¸ìŠ¤íŒ… ì„¤ì •
          aws s3 website s3://cicd-test-eunhak  \
            --index-document index.html \
            --error-document index.html

          echo "âœ… S3 ë°°í¬ ì™„ë£Œ"
          echo "ğŸŒ ì›¹ì‚¬ì´íŠ¸ URL: http://cicd-test-eunhak .s3-website.ap-northeast-2.amazonaws.com"

      - name: Verify Deployment
        run: |
          # ë°°í¬ëœ íŒŒì¼ í™•ì¸
          echo "ğŸ“‹ ë°°í¬ëœ íŒŒì¼ ëª©ë¡:"
          aws s3 ls s3://cicd-test-eunhak  --recursive

          # ì›¹ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸
          echo "ğŸ” ì›¹ì‚¬ì´íŠ¸ ìƒíƒœ í™•ì¸:"
          curl -I http://cicd-test-eunhak .s3-website.ap-northeast-2.amazonaws.com || echo "âš ï¸ ì›¹ì‚¬ì´íŠ¸ ì ‘ê·¼ ì‹¤íŒ¨: DNS ì „íŒŒ ëŒ€ê¸° ì¤‘ì´ê±°ë‚˜ S3 ì„¤ì • í™•ì¸ í•„ìš”"